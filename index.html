import { useState, useRef, useEffect } from 'react';
import { Play, Pause, SkipBack, SkipForward, Volume2, VolumeX, Loader2 } from 'lucide-react';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Slider } from '@/components/ui/slider';

// Popular reciters with their API identifiers
export const RECITERS = [
  { id: 'ar.alafasy', name: 'مشاري العفاسي', englishName: 'Mishary Alafasy' },
  { id: 'ar.bandarbalila', name: 'بندر بليلة', englishName: 'Bandar Baleela' },
  { id: 'ar.abdullahaljuhany', name: 'عبدالله الجهني', englishName: 'Abdullah Al-Juhani' },
  { id: 'ar.alwaleedalshamsan', name: 'الوليد الشمسان', englishName: 'Al-Waleed Al-Shamsan' },
  { id: 'ar.abdulbasitmurattal', name: 'عبد الباسط عبد الصمد', englishName: 'Abdul Basit (Murattal)' },
  { id: 'ar.abdurrahmaansudais', name: 'عبد الرحمن السديس', englishName: 'Abdurrahman As-Sudais' },
  { id: 'ar.ahmedajamy', name: 'أحمد العجمي', englishName: 'Ahmed Al-Ajamy' },
  { id: 'ar.maaborimoussa', name: 'ماهر المعيقلي', englishName: 'Maher Al Muaiqly' },
  { id: 'ar.minaborimoussa', name: 'محمد المنشاوي', englishName: 'Mohamed Siddiq Al-Minshawi' },
];

interface AudioPlayerProps {
  surahId: number;
  totalVerses: number;
  currentVerse: number;
  onVerseChange: (verse: number) => void;
}

const AudioPlayer = ({ surahId, totalVerses, currentVerse, onVerseChange }: AudioPlayerProps) => {
  const [isPlaying, setIsPlaying] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [reciter, setReciter] = useState('ar.alafasy');
  const [volume, setVolume] = useState(80);
  const [isMuted, setIsMuted] = useState(false);
  const [progress, setProgress] = useState(0);
  const [duration, setDuration] = useState(0);
  const audioRef = useRef<HTMLAudioElement | null>(null);

  // Calculate the global ayah number for the CDN
  const getGlobalAyahNumber = (surahNum: number, verseNum: number): number => {
    // Ayah numbers before each surah (cumulative)
    const ayahsBefore: Record<number, number> = {
      1: 0, 2: 7, 3: 293, 4: 493, 5: 669, 6: 789, 7: 954, 8: 1160, 9: 1235, 10: 1364,
      11: 1473, 12: 1596, 13: 1707, 14: 1750, 15: 1802, 16: 1901, 17: 2029, 18: 2140,
      19: 2250, 20: 2348, 21: 2483, 22: 2595, 23: 2673, 24: 2791, 25: 2855, 26: 2932,
      27: 3159, 28: 3252, 29: 3340, 30: 3409, 31: 3469, 32: 3503, 33: 3533, 34: 3606,
      35: 3660, 36: 3705, 37: 3788, 38: 3970, 39: 4058, 40: 4133, 41: 4218, 42: 4272,
      43: 4325, 44: 4414, 45: 4473, 46: 4510, 47: 4545, 48: 4583, 49: 4612, 50: 4630,
      51: 4675, 52: 4735, 53: 4784, 54: 4846, 55: 4901, 56: 4979, 57: 5075, 58: 5104,
      59: 5126, 60: 5150, 61: 5163, 62: 5177, 63: 5188, 64: 5199, 65: 5217, 66: 5229,
      67: 5241, 68: 5271, 69: 5323, 70: 5375, 71: 5419, 72: 5447, 73: 5475, 74: 5495,
      75: 5551, 76: 5591, 77: 5622, 78: 5672, 79: 5712, 80: 5758, 81: 5800, 82: 5829,
      83: 5848, 84: 5884, 85: 5909, 86: 5931, 87: 5948, 88: 5967, 89: 5993, 90: 6023,
      91: 6043, 92: 6058, 93: 6079, 94: 6090, 95: 6098, 96: 6106, 97: 6125, 98: 6130,
      99: 6138, 100: 6146, 101: 6157, 102: 6168, 103: 6176, 104: 6179, 105: 6188,
      106: 6193, 107: 6197, 108: 6204, 109: 6207, 110: 6213, 111: 6216, 112: 6221,
      113: 6225, 114: 6230
    };
    return (ayahsBefore[surahNum] || 0) + verseNum;
  };

  const getAudioUrl = (surahNum: number, verseNum: number, reciterId: string): string => {
    const globalAyah = getGlobalAyahNumber(surahNum, verseNum);
    return `https://cdn.islamic.network/quran/audio/128/${reciterId}/${globalAyah}.mp3`;
  };

  useEffect(() => {
    if (audioRef.current) {
      audioRef.current.volume = isMuted ? 0 : volume / 100;
    }
  }, [volume, isMuted]);

  useEffect(() => {
    // Load new audio when verse or reciter changes
    if (audioRef.current && isPlaying) {
      loadAndPlayAudio();
    }
  }, [currentVerse, reciter]);

  const loadAndPlayAudio = async () => {
    if (!audioRef.current) return;
    
    setIsLoading(true);
    const audioUrl = getAudioUrl(surahId, currentVerse, reciter);
    audioRef.current.src = audioUrl;
    
    try {
      await audioRef.current.load();
      await audioRef.current.play();
      setIsPlaying(true);
    } catch (error) {
      console.error('Error playing audio:', error);
    } finally {
      setIsLoading(false);
    }
  };

  const togglePlay = async () => {
    if (!audioRef.current) return;

    if (isPlaying) {
      audioRef.current.pause();
      setIsPlaying(false);
    } else {
      await loadAndPlayAudio();
    }
  };

  const handleAudioEnded = () => {
    // Auto-play next verse
    if (currentVerse < totalVerses) {
      onVerseChange(currentVerse + 1);
    } else {
      setIsPlaying(false);
    }
  };

  const handleTimeUpdate = () => {
    if (audioRef.current) {
      setProgress(audioRef.current.currentTime);
      setDuration(audioRef.current.duration || 0);
    }
  };

  const handleSeek = (value: number[]) => {
    if (audioRef.current) {
      audioRef.current.currentTime = value[0];
      setProgress(value[0]);
    }
  };

  const goToPrevVerse = () => {
    if (currentVerse > 1) {
      onVerseChange(currentVerse - 1);
    }
  };

  const goToNextVerse = () => {
    if (currentVerse < totalVerses) {
      onVerseChange(currentVerse + 1);
    }
  };

  const formatTime = (time: number): string => {
    if (!time || isNaN(time)) return '0:00';
    const minutes = Math.floor(time / 60);
    const seconds = Math.floor(time % 60);
    return `${minutes}:${seconds.toString().padStart(2, '0')}`;
  };

  return (
    <div className="fixed bottom-0 left-0 right-0 z-50 bg-card/95 backdrop-blur-lg border-t border-border shadow-xl">
      <audio
        ref={audioRef}
        onEnded={handleAudioEnded}
        onTimeUpdate={handleTimeUpdate}
        onLoadedMetadata={handleTimeUpdate}
      />
      
      <div className="container mx-auto px-4 py-3">
        <div className="flex flex-col gap-3">
          {/* Progress bar */}
          <div className="flex items-center gap-3">
            <span className="text-xs text-muted-foreground w-10 text-left">
              {formatTime(progress)}
            </span>
            <Slider
              value={[progress]}
              max={duration || 100}
              step={0.1}
              onValueChange={handleSeek}
              className="flex-1"
            />
            <span className="text-xs text-muted-foreground w-10 text-right">
              {formatTime(duration)}
            </span>
          </div>

          {/* Controls */}
          <div className="flex items-center justify-between gap-4">
            {/* Reciter selector */}
            <div className="hidden sm:block w-48">
              <Select value={reciter} onValueChange={setReciter}>
                <SelectTrigger className="h-9 text-sm">
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  {RECITERS.map((r) => (
                    <SelectItem key={r.id} value={r.id}>
                      <span className="font-amiri">{r.name}</span>
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            {/* Playback controls */}
            <div className="flex items-center gap-2">
              <button
                onClick={goToNextVerse}
                disabled={currentVerse >= totalVerses}
                className="p-2 rounded-full hover:bg-secondary transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                title="الآية التالية"
              >
                <SkipForward className="w-5 h-5 text-foreground" />
              </button>

              <button
                onClick={togglePlay}
                disabled={isLoading}
                className="w-12 h-12 rounded-full gradient-gold flex items-center justify-center shadow-lg hover:opacity-90 transition-opacity disabled:opacity-70"
              >
                {isLoading ? (
                  <Loader2 className="w-6 h-6 text-foreground animate-spin" />
                ) : isPlaying ? (
                  <Pause className="w-6 h-6 text-foreground" />
                ) : (
                  <Play className="w-6 h-6 text-foreground mr-[-2px]" />
                )}
              </button>

              <button
                onClick={goToPrevVerse}
                disabled={currentVerse <= 1}
                className="p-2 rounded-full hover:bg-secondary transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                title="الآية السابقة"
              >
                <SkipBack className="w-5 h-5 text-foreground" />
              </button>
            </div>

            {/* Volume control & verse info */}
            <div className="flex items-center gap-3">
              <div className="hidden md:flex items-center gap-2">
                <button
                  onClick={() => setIsMuted(!isMuted)}
                  className="p-2 rounded-full hover:bg-secondary transition-colors"
                >
                  {isMuted || volume === 0 ? (
                    <VolumeX className="w-4 h-4 text-muted-foreground" />
                  ) : (
                    <Volume2 className="w-4 h-4 text-muted-foreground" />
                  )}
                </button>
                <Slider
                  value={[isMuted ? 0 : volume]}
                  max={100}
                  step={1}
                  onValueChange={(v) => {
                    setVolume(v[0]);
                    setIsMuted(false);
                  }}
                  className="w-20"
                />
              </div>
              
              <div className="text-sm text-muted-foreground font-amiri whitespace-nowrap" dir="rtl">
                آية {currentVerse} / {totalVerses}
              </div>
            </div>
          </div>

          {/* Mobile reciter selector */}
          <div className="sm:hidden">
            <Select value={reciter} onValueChange={setReciter}>
              <SelectTrigger className="h-9 text-sm">
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                {RECITERS.map((r) => (
                  <SelectItem key={r.id} value={r.id}>
                    <span className="font-amiri">{r.name}</span>
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
          </div>
        </div>
      </div>
    </div>
  );
};

export default AudioPlayer;


