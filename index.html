<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ØµØ­Ù Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰ - Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø§Øª</title>
    https://cdn.tailwindcss.com</script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    https://fonts.googleapis.com/css2?family=Amiri&family=Tajawal:wght@400;700&family=Scheherazade+New:wght@400;700&display=swap
    <style>
        :root { --primary: #d4af37; --bg-light: #fcfbf7; }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg-light); transition: 0.3s; }
        .quran-page { font-family: 'Scheherazade New', serif; line-height: 2.8; text-align: justify; text-align-last: center; }

        .ayah-span { cursor: pointer; transition: 0.2s; padding: 2px 4px; border-radius: 4px; display: inline; }
        .ayah-span:hover { background: rgba(212, 175, 55, 0.15); }
        .ayah-active { background: #fff3cd !important; color: #856404; box-shadow: 0 0 10px rgba(212,175,55,0.3); }

        /* âœ… New bookmark highlight (changed color on saving reading position) */
        .ayah-bookmarked { 
            background: #ffe9c7 !important; 
            color: #7a4a00; 
            border: 1px solid #f5c16a; 
            box-shadow: 0 0 0 2px rgba(245, 193, 106, 0.25);
        }
        .dark .ayah-bookmarked { 
            background: #3b2a12 !important; 
            color: #fbd38d; 
            border-color: #8a6b3b;
        }

        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }
    </style>
</head>
<body class="dark:bg-zinc-950 dark:text-zinc-100">

    <header class="sticky top-0 z-50 bg-white/90 dark:bg-zinc-900/90 backdrop-blur-md border-b dark:border-zinc-800 p-4">
        <div class="max-w-7xl mx-auto flex flex-wrap justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <div class="text-2xl">ğŸ“–</div>
                <h1 class="text-xl font-bold text-amber-600">Ù…ØµØ­Ù Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰</h1>
            </div>

            <!-- âœ… unified search: surah name + ayah text + ayah key (e.g., 2:255) -->
            <div class="flex-1 max-w-md relative">
                <input id="globalSearch" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø³ÙˆØ±Ø© Ø£Ùˆ Ø¢ÙŠØ©..." 
                       class="w-full bg-slate-100 dark:bg-zinc-800 rounded-full px-5 py-2 text-sm outline-none focus:ring-2 ring-amber-500">
                <div id="searchResults" class="absolute top-12 left-0 w-full bg-white dark:bg-zinc-800 shadow-2xl rounded-2xl max-h-96 overflow-y-auto hidden z-[60] custom-scroll"></div>
            </div>

            <div class="flex items-center gap-3">
                <!-- âœ… Reciters list with Baleela/Sudais removed -->
                <select id="reciterSelect" class="bg-slate-100 dark:bg-zinc-800 rounded-lg px-3 py-2 text-xs outline-none"></select>
                <button onclick="document.documentElement.classList.toggle('dark')" class="p-2 rounded-full bg-slate-100 dark:bg-zinc-800">ğŸŒ“</button>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4 md:p-10">
        <div id="quran-paper" class="bg-white dark:bg-zinc-900 shadow-2xl rounded-[2rem] p-8 md:p-16 border border-amber-50 dark:border-zinc-800 relative min-h-[80vh]">

            <div id="pageHeader" class="flex justify-between items-center mb-10 border-b pb-4 opacity-60 text-sm">
                <span id="surahInfo">Ø³ÙˆØ±Ø© Ø§Ù„ÙØ§ØªØ­Ø©</span>
                <span class="text-amber-600 font-bold">Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù€Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ€Ù°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù</span>
                <span id="pageInfo">Ø§Ù„ØµÙØ­Ø© Ù¡ â€¢ Ø§Ù„Ø¬Ø²Ø¡ Ù¡</span>
            </div>

            <div id="pageContent" class="quran-page text-3xl md:text-4xl"></div>

            <!-- âœ… Page navigator -->
            <div class="mt-8 flex items-center justify-center gap-4">
                <button id="prevPageBtn" class="px-4 py-2 rounded-xl bg-slate-100 dark:bg-zinc-800 hover:bg-amber-50 dark:hover:bg-zinc-700">â¬…ï¸ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</button>
                <div class="text-sm opacity-60">Ø¹Ø±Ø¶ Ø¨Ø§Ù„Ù…ØµØ­Ù (ØµÙØ­Ø§Øª)</div>
                <button id="nextPageBtn" class="px-4 py-2 rounded-xl bg-slate-100 dark:bg-zinc-800 hover:bg-amber-50 dark:hover:bg-zinc-700">Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© â¡ï¸</button>
            </div>
        </div>

        <div id="tafsirCard" class="mt-6 bg-amber-50 dark:bg-zinc-800/50 p-6 rounded-2xl border-r-4 border-amber-500 hidden transition-all">
            <h4 class="font-bold text-amber-800 dark:text-amber-500 mb-2">Ø§Ù„ØªÙØ³ÙŠØ± Ø§Ù„Ù…ÙŠØ³Ø±:</h4>
            <p id="tafsirText" class="text-lg leading-relaxed"></p>
        </div>
    </main>

    <div id="playerBar" class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-lg bg-white/95 dark:bg-zinc-900/95 border dark:border-zinc-700 shadow-2xl rounded-3xl p-4 flex items-center gap-4 z-50 transform translate-y-32 transition-all">
        <button id="mainPlayBtn" class="w-12 h-12 bg-amber-500 rounded-2xl flex items-center justify-center text-white shadow-lg">â–¶ï¸</button>
        <div class="flex-1">
            <div id="currentPlaying" class="text-xs font-bold text-amber-600 truncate">...</div>
            <div class="h-1 bg-slate-100 dark:bg-zinc-800 rounded-full mt-2"><div id="progress" class="h-full bg-amber-500 w-0"></div></div>
        </div>
        <button onclick="this.parentElement.classList.add('translate-y-32')" class="text-xs opacity-30">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <audio id="audioElement"></audio>

    <script>
        const API = "https://api.quran.com/api/v4";

        // âœ… Reciters (Baleela & Sudais removed as requested)
        const reciters = [
            { id: "Abdullaah_3awwaad_Al-Juhaynee_128kbps", name: "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø¬Ù‡Ù†ÙŠ" },
            { id: "Maher_AlMuaiqly_64kbps", name: "Ù…Ø§Ù‡Ø± Ø§Ù„Ù…Ø¹ÙŠÙ‚Ù„ÙŠ" },
            { id: "Yasser_Ad-Dussary_128kbps", name: "ÙŠØ§Ø³Ø± Ø§Ù„Ø¯ÙˆØ³Ø±ÙŠ" },
            { id: "Alafasy_128kbps", name: "Ù…Ø´Ø§Ø±ÙŠ Ø§Ù„Ø¹ÙØ§Ø³ÙŠ" }
        ];

        let currentAyahs = [];
        let bookmarkedKey = localStorage.getItem('quran_bookmark_key');
        let currentPage = 1;      // âœ… mushaf page
        const MAX_PAGE = 604;     // pages in Madani Mushaf
        let chaptersMap = {};     // { id: {name_arabic: '', pagesRange: [start,end]? }, ... }

        window.onload = async () => {
            // populate reciters
            const rSelect = document.getElementById('reciterSelect');
            rSelect.innerHTML = reciters.map(r => `<option value="${r.id}">${r.name}</option>`).join('');

            // load chapters (for local surah search + headers)
            await loadChapters();

            // default: show page 1 (Al-Fatiha first page)
            await loadPage(1);

            initSearch();

            // page navigation
            document.getElementById('prevPageBtn').onclick = async () => {
                if (currentPage > 1) await loadPage(currentPage - 1);
            };
            document.getElementById('nextPageBtn').onclick = async () => {
                if (currentPage < MAX_PAGE) await loadPage(currentPage + 1);
            };
        };

        // âœ… load chapters (names for header and search)
        async function loadChapters() {
            try {
                const res = await fetch(`${API}/chapters?language=ar`);
                const data = await res.json();
                (data.chapters || []).forEach(ch => {
                    chaptersMap[ch.id] = { name: ch.name_arabic };
                });
            } catch (e) {
                console.warn('Failed to load chapters list', e);
            }
        }

        // âœ… load by mushaf page (verses are still segmented, but rendered as one page flow)
        async function loadPage(pageNumber) {
            const res = await fetch(`${API}/quran/verses/uthmani_by_page?page_number=${pageNumber}`);
            const data = await res.json();
            currentAyahs = data.verses || [];
            currentPage = pageNumber;

            // Header info: surah of first verse + juz of first verse
            if (currentAyahs.length > 0) {
                const first = currentAyahs[0];
                const surahName = chaptersMap[first.chapter_id]?.name || `Ø³ÙˆØ±Ø© ${first.chapter_id}`;
                document.getElementById('surahInfo').textContent = surahName;
                document.getElementById('pageInfo').textContent = `Ø§Ù„ØµÙØ­Ø© ${currentPage} â€¢ Ø§Ù„Ø¬Ø²Ø¡ ${first.juz_number}`;
            } else {
                document.getElementById('surahInfo').textContent = '...';
                document.getElementById('pageInfo').textContent = `Ø§Ù„ØµÙØ­Ø© ${currentPage}`;
            }

            renderPage();
        }

        function renderPage() {
            const container = document.getElementById('pageContent');
            container.innerHTML = currentAyahs.map((v, i) => {
                const isBookmarked = v.verse_key === bookmarkedKey;
                return `<span id="ayah-${i}" 
                              class="ayah-span ${isBookmarked ? 'ayah-bookmarked' : ''}" 
                              onclick="handleAyahClick(${i})">
                        ${v.text_uthmani} 
                        <span class="text-amber-600 font-sans text-xl mx-1">ï´¿${v.ayah_number}ï´¾</span>
                    </span>`;
            }).join(' ');
        }

        async function handleAyahClick(index) {
            const ayah = currentAyahs[index];
            const [s, a] = ayah.verse_key.split(':');

            // 1) highlight
            document.querySelectorAll('.ayah-span').forEach(el => el.classList.remove('ayah-active'));
            document.getElementById(`ayah-${index}`).classList.add('ayah-active');

            // 2) audio
            const reciter = document.getElementById('reciterSelect').value;
            const audioUrl = `https://www.everyayah.com/data/${reciter}/${String(s).padStart(3,'0')}${String(a).padStart(3,'0')}.mp3`;
            const audio = document.getElementById('audioElement');
            audio.src = audioUrl;
            audio.play();

            // 3) UI
            document.getElementById('playerBar').classList.remove('translate-y-32');
            document.getElementById('currentPlaying').textContent = `Ø¬Ø§Ø±ÙŠ ØªØ´ØºÙŠÙ„ Ø¢ÙŠØ© Ø±Ù‚Ù… ${a}`;
            document.getElementById('mainPlayBtn').textContent = 'â¸ï¸';

            // 4) tafsir (Ø§Ù„ØªÙØ³ÙŠØ± Ø§Ù„Ù…ÙŠØ³Ø± - id=16)
            loadTafsir(ayah.verse_key);

            // 5) bookmark: âœ… changes color immediately
            saveBookmark(ayah.verse_key);

            // auto-next within page
            audio.onended = () => {
                if (index + 1 < currentAyahs.length) handleAyahClick(index + 1);
            };
        }

        async function loadTafsir(key) {
            const card = document.getElementById('tafsirCard');
            const text = document.getElementById('tafsirText');
            card.classList.remove('hidden');
            text.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...";
            try {
                const res = await fetch(`${API}/tafsirs/16/by_ayah/${key}`);
                const data = await res.json();
                text.textContent = data.tafsir.text;
            } catch (e) {
                text.textContent = "ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ³ÙŠØ±. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§.";
            }
        }

        function saveBookmark(key) {
            bookmarkedKey = key;
            localStorage.setItem('quran_bookmark_key', key);
            // âœ… update colors immediately
            document.querySelectorAll('.ayah-span').forEach(el => el.classList.remove('ayah-bookmarked'));
            const activeAyah = currentAyahs.findIndex(v => v.verse_key === key);
            if (activeAyah !== -1) document.getElementById(`ayah-${activeAyah}`).classList.add('ayah-bookmarked');
        }

        // âœ… unified dual-mode search (surah names locally + ayah text via API + ayah key "S:A")
        function initSearch() {
            const input = document.getElementById('globalSearch');
            const results = document.getElementById('searchResults');

            input.addEventListener('input', async (e) => {
                const query = e.target.value.trim();
                if (query.length < 2) { results.classList.add('hidden'); results.innerHTML = ''; return; }

                results.innerHTML = '';
                results.classList.remove('hidden');

                // 1) direct ayah key pattern "S:A"
                const keyMatch = query.match(/^(\d{1,3})\s*[:ï¼š]\s*(\d{1,3})$/);
                if (keyMatch) {
                    const sId = parseInt(keyMatch[1], 10);
                    const aNum = parseInt(keyMatch[2], 10);
                    const div = document.createElement('div');
                    div.className = "p-4 hover:bg-amber-50 dark:hover:bg-zinc-700 cursor-pointer border-b dark:border-zinc-700";
                    div.innerHTML = `<div class="text-xs text-amber-600">${sId}:${aNum}</div>
                                     <div class="text-sm font-bold">Ø§Ù†ØªÙ‚Ø§Ù„ Ù…Ø¨Ø§Ø´Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø¢ÙŠØ©</div>`;
                    div.onclick = async () => {
                        // load surah to get verse page, then load that page and focus
                        const res = await fetch(`${API}/quran/verses/uthmani?chapter_number=${sId}`);
                        const data = await res.json();
                        const verses = data.verses || [];
                        const v = verses.find(x => Number(x.ayah_number) === aNum);
                        if (v) {
                            await loadPage(v.page_number);
                            const idx = currentAyahs.findIndex(x => x.verse_key === v.verse_key);
                            if (idx !== -1) handleAyahClick(idx);
                        }
                        results.classList.add('hidden');
                    };
                    results.appendChild(div);
                }

                // 2) surah name local filter
                const chapterMatches = Object.entries(chaptersMap)
                    .filter(([id, obj]) => obj.name.includes(query))
                    .slice(0, 10);

                chapterMatches.forEach(([id, obj]) => {
                    const div = document.createElement('div');
                    div.className = "p-4 hover:bg-amber-50 dark:hover:bg-zinc-700 cursor-pointer border-b dark:border-zinc-700";
                    div.innerHTML = `<div class="text-xs text-amber-600">Ø³ÙˆØ±Ø©</div>
                                     <div class="text-sm font-bold">${obj.name}</div>`;
                    div.onclick = async () => {
                        // find the first page that contains this surah
                        // simplest approach: load first verse of chapter to get its page_number
                        const res = await fetch(`${API}/quran/verses/uthmani?chapter_number=${id}`);
                        const data = await res.json();
                        const verses = data.verses || [];
                        if (verses.length > 0) {
                            await loadPage(verses[0].page_number);
                        }
                        results.classList.add('hidden');
                    };
                    results.appendChild(div);
                });

                // 3) ayah text API search
                try {
                    const res = await fetch(`${API}/search?q=${encodeURIComponent(query)}&language=ar`);
                    const data = await res.json();

                    if ((data.results || []).length > 0) {
                        data.results.slice(0, 20).forEach(item => {
                            const div = document.createElement('div');
                            div.className = "p-4 hover:bg-amber-50 dark:hover:bg-zinc-700 cursor-pointer border-b dark:border-zinc-700";
                            div.innerHTML = `<div class="text-xs text-amber-600">${item.verse_key}</div>
                                             <div class="text-sm font-bold">${item.text.replace(/<(?:.|\n)*?>/gm, '')}</div>`;
                            div.onclick = async () => {
                                const [sId] = item.verse_key.split(':');
                                const res = await fetch(`${API}/quran/verses/uthmani?chapter_number=${sId}`);
                                const data = await res.json();
                                const verses = data.verses || [];
                                const target = verses.find(v => v.verse_key === item.verse_key);
                                if (target) {
                                    await loadPage(target.page_number);
                                    const idx = currentAyahs.findIndex(v => v.verse_key === item.verse_key);
                                    if (idx !== -1) handleAyahClick(idx);
                                }
                                results.classList.add('hidden');
                            };
                            results.appendChild(div);
                        });
                    } else {
                        if (!results.innerHTML) {
                            results.innerHTML = '<div class="p-4 text-center opacity-50">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
                        }
                    }
                } catch (e) {
                    // fall back message
                    if (!results.innerHTML) {
                        results.innerHTML = '<div class="p-4 text-center opacity-50">ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù…Ø­Ø±Ùƒ Ø§Ù„Ø¨Ø­Ø«</div>';
                    }
                }
            });
        }

        // audio controls
        document.getElementById('mainPlayBtn').onclick = () => {
            const audio = document.getElementById('audioElement');
            if (audio.paused) { audio.play(); document.getElementById('mainPlayBtn').textContent = 'â¸ï¸'; }
            else { audio.pause(); document.getElementById('mainPlayBtn').textContent = 'â–¶ï¸'; }
        };

        const audio = document.getElementById('audioElement');
        audio.ontimeupdate = () => {
            const p = (audio.currentTime / audio.duration) * 100;
            document.getElementById('progress').style.width = (isFinite(p) ? p : 0) + '%';
        };
    </script>
</body>
</html>
          
