<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ØµØ­Ù Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰ | ØªØ¬Ø±Ø¨Ø© Ø§Ø³ØªÙ…Ø§Ø¹ Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Amiri&family=Tajawal:wght@400;700&family=Scheherazade+New:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #d4af37; --bg-light: #fdfdfb; --bg-dark: #121212; }
        body { font-family: 'Tajawal', sans-serif; transition: 0.3s; background: var(--bg-light); }
        .quran-text { font-family: 'Scheherazade New', serif; line-height: 2.5; }
        .ayah-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border-right: 4px solid transparent; }
        .ayah-card.active { background: #fffdf5; border-right-color: var(--primary); transform: scale(1.01); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .dark .ayah-card.active { background: #1e1e1e; border-right-color: var(--primary); }
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: var(--primary); }
        .play-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(212, 175, 55, 0); } 100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); } }
    </style>
</head>
<body class="dark:bg-zinc-950 text-slate-800 dark:text-zinc-200">

    <header class="sticky top-0 z-50 bg-white/80 dark:bg-zinc-900/80 backdrop-blur-md border-b dark:border-zinc-800 p-4 shadow-sm">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-amber-500 rounded-xl flex items-center justify-center text-white shadow-lg">ğŸ•‹</div>
                <h1 class="text-xl font-bold bg-gradient-to-r from-amber-600 to-yellow-500 bg-clip-text text-transparent uppercase">Ù…ØµØ­Ù Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰</h1>
            </div>
            
            <div class="flex items-center gap-2">
                <select id="reciterSelect" class="bg-slate-100 dark:bg-zinc-800 rounded-lg px-3 py-2 text-sm outline-none border-none focus:ring-2 ring-amber-500"></select>
                <button onclick="document.documentElement.classList.toggle('dark')" class="p-2 rounded-lg bg-slate-100 dark:bg-zinc-800">ğŸŒ“</button>
            </div>
        </div>
    </header>

    <div class="max-w-6xl mx-auto flex h-[calc(100vh-80px)]">
        <aside class="w-72 hidden md:flex flex-col border-l dark:border-zinc-800 bg-white dark:bg-zinc-900 overflow-hidden">
            <div class="p-4 border-b dark:border-zinc-800">
                <input id="searchSurah" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø³ÙˆØ±Ø©..." class="w-full bg-slate-50 dark:bg-zinc-800 rounded-lg px-4 py-2 text-sm outline-none">
            </div>
            <div id="surahList" class="flex-1 overflow-y-auto custom-scroll p-2"></div>
        </aside>

        <main class="flex-1 overflow-y-auto custom-scroll p-4 md:p-8" id="mainView">
            <div id="surahHeader" class="text-center mb-10 hidden">
                <h2 id="currentSurahName" class="text-4xl font-bold text-amber-600 mb-2 quran-text"></h2>
                <p id="surahMeta" class="text-sm opacity-50"></p>
                <div class="my-6"><img src="https://upload.wikimedia.org/wikipedia/commons/e/e4/Bismillah.svg" class="h-12 mx-auto dark:invert opacity-70"></div>
            </div>

            <div id="ayahsContainer" class="space-y-4 pb-32">
                </div>
        </main>
    </div>

    <div id="playerUI" class="fixed bottom-8 left-1/2 -translate-x-1/2 w-[90%] max-w-lg bg-white dark:bg-zinc-900 border border-amber-100 dark:border-zinc-800 rounded-3xl shadow-2xl p-4 flex items-center gap-4 z-50 transform translate-y-32 transition-transform duration-500">
        <button id="togglePlay" class="w-14 h-14 bg-amber-500 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-amber-500/30 play-pulse">
            <svg id="playIcon" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M4.5 3.5v13l11-6.5-11-6.5z"/></svg>
        </button>
        
        <div class="flex-1">
            <div id="trackInfo" class="text-xs font-bold text-amber-600 mb-1">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            <div id="tafsirBrief" class="text-[10px] opacity-60 truncate">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø¢ÙŠØ© Ù„Ù„ØªÙØ³ÙŠØ±</div>
            <div class="h-1 bg-slate-100 dark:bg-zinc-800 rounded-full mt-2 overflow-hidden">
                <div id="audioProgress" class="h-full bg-amber-500 w-0"></div>
            </div>
        </div>

        <button id="closePlayer" class="p-2 opacity-30 hover:opacity-100">âœ•</button>
    </div>

    <audio id="mainAudio"></audio>

    <script>
        const API_BASE = "https://api.quran.com/api/v4";
        const AUDIO_SERVER = "https://www.everyayah.com/data";
        
        const reciters = [
            { id: "Abdurrahmane_As-Sudais_192kbps", name: "Ø§Ù„Ø³Ø¯ÙŠØ³ (Ø§Ù„Ø­Ø±Ù…)" },
            { id: "Bander_Balila_128kbps", name: "Ø¨Ù†Ø¯Ø± Ø¨Ù„ÙŠÙ„Ø© (Ø§Ù„Ø­Ø±Ù…)" },
            { id: "Abdullaah_3awwaad_Al-Juhaynee_128kbps", name: "Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡ Ø§Ù„Ø¬Ù‡Ù†ÙŠ (Ø§Ù„Ø­Ø±Ù…)" },
            { id: "Maher_AlMuaiqly_64kbps", name: "Ù…Ø§Ù‡Ø± Ø§Ù„Ù…Ø¹ÙŠÙ‚Ù„ÙŠ (Ø§Ù„Ø­Ø±Ù…)" },
            { id: "Yasser_Ad-Dussary_128kbps", name: "ÙŠØ§Ø³Ø± Ø§Ù„Ø¯ÙˆØ³Ø±ÙŠ (Ø§Ù„Ø­Ø±Ù…)" },
            { id: "Alafasy_128kbps", name: "Ù…Ø´Ø§Ø±ÙŠ Ø§Ù„Ø¹ÙØ§Ø³ÙŠ" }
        ];

        let currentAyahs = [];
        let activeIndex = -1;
        let currentSurahId = 1;

        // Initialize
        window.onload = () => {
            const select = document.getElementById('reciterSelect');
            select.innerHTML = reciters.map(r => `<option value="${r.id}">${r.name}</option>`).join('');
            
            loadSurahs();
            checkBookmark();
        };

        async function loadSurahs() {
            const res = await fetch(`${API_BASE}/chapters?language=ar`);
            const data = await res.json();
            const list = document.getElementById('surahList');
            
            list.innerHTML = data.chapters.map(s => `
                <div onclick="loadSurah(${s.id}, '${s.name_arabic}')" class="p-3 mb-1 rounded-xl cursor-pointer hover:bg-amber-50 dark:hover:bg-zinc-800 transition group flex justify-between items-center">
                    <span class="font-bold text-sm">${s.id}. ${s.name_arabic}</span>
                    <span class="text-[10px] opacity-40">${s.verses_count} Ø¢ÙŠØ©</span>
                </div>
            `).join('');
        }

        async function loadSurah(id, name) {
            currentSurahId = id;
            document.getElementById('surahHeader').classList.remove('hidden');
            document.getElementById('currentSurahName').textContent = name;
            document.getElementById('ayahsContainer').innerHTML = '<div class="text-center py-10 opacity-50">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¢ÙŠØ§Øª...</div>';
            
            const res = await fetch(`${API_BASE}/quran/verses/uthmani?chapter_number=${id}`);
            const data = await res.json();
            currentAyahs = data.verses;
            
            renderAyahs();
        }

        function renderAyahs() {
            const container = document.getElementById('ayahsContainer');
            container.innerHTML = currentAyahs.map((v, i) => `
                <div id="ayah-${i}" class="ayah-card p-6 bg-white dark:bg-zinc-900 rounded-2xl shadow-sm cursor-pointer" onclick="playAyah(${i})">
                    <div class="flex justify-between items-start mb-4">
                        <span class="w-8 h-8 rounded-full bg-amber-50 dark:bg-zinc-800 flex items-center justify-center text-xs font-bold text-amber-600">${i+1}</span>
                        <button onclick="saveBookmark(${i}, event)" class="text-xs opacity-40 hover:opacity-100">ğŸ”– Ø­ÙØ¸</button>
                    </div>
                    <p class="quran-text text-3xl text-right leading-[3.5rem]">${v.text_uthmani}</p>
                    <div id="tafsir-${i}" class="mt-4 text-sm text-amber-700 dark:text-amber-500 hidden pt-4 border-t border-amber-50 dark:border-zinc-800 italic"></div>
                </div>
            `).join('');
        }

        async function playAyah(index) {
            if (index >= currentAyahs.length) return;
            
            activeIndex = index;
            const ayah = currentAyahs[index];
            const [surahNum, ayahNum] = ayah.verse_key.split(':');
            
            // UI Update
            document.querySelectorAll('.ayah-card').forEach(el => el.classList.remove('active'));
            const card = document.getElementById(`ayah-${index}`);
            card.classList.add('active');
            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Audio Path Construction
            const reciter = document.getElementById('reciterSelect').value;
            const s = surahNum.padStart(3, '0');
            const a = ayahNum.padStart(3, '0');
            const audioUrl = `${AUDIO_SERVER}/${reciter}/${s}${a}.mp3`;
            
            const audio = document.getElementById('mainAudio');
            audio.src = audioUrl;
            audio.play();

            // Player UI
            document.getElementById('playerUI').classList.remove('translate-y-32');
            document.getElementById('trackInfo').textContent = `Ø³ÙˆØ±Ø© Ø§Ù„ÙØ§ØªØ­Ø© - Ø¢ÙŠØ© ${ayahNum}`;
            document.getElementById('playIcon').innerHTML = '<path d="M6 4h4v12H6V4zm4 0h4v12h-4V4z"/>';

            // Fetch Tafsir
            loadTafsir(ayah.verse_key, index);

            // Auto-next
            audio.onended = () => playAyah(index + 1);
        }

        async function loadTafsir(key, index) {
            const el = document.getElementById(`tafsir-${index}`);
            el.classList.remove('hidden');
            el.textContent = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙØ³ÙŠØ±...";
            
            const res = await fetch(`${API_BASE}/tafsirs/16/by_ayah/${key}`);
            const data = await res.json();
            el.textContent = data.tafsir.text;
            document.getElementById('tafsirBrief').textContent = data.tafsir.text;
        }

        // Bookmark Logic
        function saveBookmark(index, event) {
            event.stopPropagation();
            const data = {
                surahId: currentSurahId,
                surahName: document.getElementById('currentSurahName').textContent,
                ayahIndex: index
            };
            localStorage.setItem('quran_bookmark', JSON.stringify(data));
            alert('ØªÙ… Ø­ÙØ¸ Ù…ÙˆØ¶Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø¨Ù†Ø¬Ø§Ø­');
        }

        function checkBookmark() {
            const saved = localStorage.getItem('quran_bookmark');
            if (saved) {
                const data = JSON.parse(saved);
                if (confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ ${data.surahName} Ø¢ÙŠØ© ${data.ayahIndex + 1}ØŸ`)) {
                    loadSurah(data.surahId, data.surahName).then(() => {
                        setTimeout(() => playAyah(data.ayahIndex), 1000);
                    });
                }
            }
        }

        // Audio Controls
        document.getElementById('togglePlay').onclick = () => {
            const audio = document.getElementById('mainAudio');
            if (audio.paused) {
                audio.play();
                document.getElementById('playIcon').innerHTML = '<path d="M6 4h4v12H6V4zm4 0h4v12h-4V4z"/>';
            } else {
                audio.pause();
                document.getElementById('playIcon').innerHTML = '<path d="M4.5 3.5v13l11-6.5-11-6.5z"/>';
            }
        };

        const audio = document.getElementById('mainAudio');
        audio.ontimeupdate = () => {
            const prog = (audio.currentTime / audio.duration) * 100;
            document.getElementById('audioProgress').style.width = prog + '%';
        };

        document.getElementById('closePlayer').onclick = () => {
            document.getElementById('playerUI').classList.add('translate-y-32');
            audio.pause();
        };
    </script>
</body>
</html>
