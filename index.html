
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ù…ØµØ­Ù Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰</title>

  <!-- Tailwind CSS -->
  https://cdn.tailwindcss.com</script>

  <!-- Ø®Ø·ÙˆØ· Ø¹Ø±Ø¨ÙŠØ© -->
  https://fonts.googleapis.com/css2?family=Amiri&family=Scheherazade+New:wght@400;700&display=swap

  <style>
    :root{
      --bg:#0f172a;       /* Ø®Ù„ÙÙŠØ© Ø¯Ø§ÙƒÙ†Ø© */
      --panel:#1f2937;    /* Ø£Ù„ÙˆØ§Ø­ Ø¯Ø§ÙƒÙ†Ø© */
      --text:#e5e7eb;     /* Ù†Øµ ÙØ§ØªØ­ */
      --muted:#a1a1aa;    /* Ù†Øµ Ø®Ø§ÙØª */
      --green:#34d399;    /* Ø£Ø®Ø¶Ø± */
      --green-700:#059669;/* Ø£Ø®Ø¶Ø± ØºØ§Ù…Ù‚ */
      --gold:#d4af37;     /* Ø°Ù‡Ø¨ÙŠ Ø®ÙÙŠÙ */
    }
    body { font-family: 'Amiri', serif; background: var(--bg); color: var(--text); }
    .quran-font { font-family: 'Scheherazade New', serif; }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: var(--green); border-radius: 10px; }
    .ayah-active { background: rgba(52,211,153,0.08); border-color: var(--green); }
    .bookmarked { background: rgba(52,211,153,0.15) !important; border-color: var(--green-700) !important; }
    .toolbar-icon { color: var(--green); }
    .btn { display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .75rem; border-radius:999px; border:1px solid transparent; background: rgba(255,255,255,0.06); color: var(--text); }
    .btn:hover { border-color: var(--green); }
    .audio-bar { background: var(--panel); color: var(--text); }
    .badge { border:1px solid var(--green); color: var(--green); border-radius:999px; padding:.1rem .5rem; font-size:.8rem; }
  </style>
</head>
<body>

  <!-- Ø±Ø£Ø³ Ø¨Ø³ÙŠØ· Ø¨ÙˆØ¶Ø¹ Ø¯Ø§ÙƒÙ† ÙˆØ£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
  <header class="sticky top-0 z-50 border-b border-gray-700 bg-[#121826]/80 backdrop-blur-md">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="inline-block w-2 h-8 rounded" style="background:var(--gold)"></span>
        <h1 class="text-2xl font-bold" style="color:var(--gold)">Ù…ØµØ­Ù Ø£Ù… Ø§Ù„Ù‚Ø±Ù‰</h1>
      </div>

      <div class="flex items-center gap-3">
        <!-- Ø¨Ø­Ø« Ø³ÙˆØ±Ø© Ø£Ùˆ Ø¢ÙŠØ© -->
        <div class="flex items-center gap-2 bg-[#1f2937] rounded-full px-3 py-1.5">
          <input id="search-input" type="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø³ÙˆØ±Ø© Ø£Ùˆ Ø¢ÙŠØ© (Ù…Ø«Ø§Ù„: 2:255)"
                 class="bg-transparent text-sm text-gray-200 focus:outline-none w-52" />
          <button id="search-btn" class="toolbar-icon" title="Ø¨Ø­Ø«">
            <!-- ğŸ” -->
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
              <path d="M21 21l-4.3-4.3" stroke="#34d399" stroke-width="2" stroke-linecap="round"/>
              <circle cx="11" cy="11" r="7" stroke="#34d399" stroke-width="2"/>
            </svg>
          </button>
        </div>

        <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙˆØ± (Ù‚Ø§Ø¦Ù…Ø© Ø¬Ø§Ù†Ø¨ÙŠØ© ØªÙÙØªØ­) -->
        <button id="toggle-chapters" class="toolbar-icon" title="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙˆØ±">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path d="M4 6h16M4 12h16M4 18h16" stroke="#34d399" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>
    </div>
  </header>

  <div class="flex">
    <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ Ù„Ù„Ø³ÙˆØ± -->
    <aside id="chapters-drawer"
           class="fixed md:static md:w-72 top-0 right-0 h-full md:h-[calc(100vh-64px)] md:mt-[64px] bg-[#111827] border-l border-gray-700 custom-scrollbar overflow-y-auto transform translate-x-full md:translate-x-0 transition-transform duration-300 z-40">
      <div class="p-3 border-b border-gray-700">
        <input id="chapters-search" type="search" placeholder="Ø§Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙˆØ±"
               class="w-full bg-[#1f2937] rounded-lg px-3 py-2 text-sm text-gray-200 focus:outline-none"/>
      </div>
      <div id="chapters-list" class="divide-y divide-gray-700"></div>
    </aside>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (ØµÙØ­Ø§Øª Ø§Ù„Ù…ØµØ­Ù) -->
    <main class="flex-1">
      <div class="max-w-5xl mx-auto px-4 md:px-6 py-6">
        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØµÙØ­Ø© -->
        <div class="mb-3 flex items-center justify-between">
          <div class="flex items-center gap-2 text-sm text-gray-300">
            <span id="surah-title" class="font-bold">Ø³ÙˆØ±Ø© Ø§Ù„ÙØ§ØªØ­Ø©</span>
            <span id="page-indicator" class="badge">ØµÙØ­Ø© <span id="page-number">1</span> / 604</span>
          </div>
          <div class="flex items-center gap-2">
            <button id="prev-page" class="btn" title="Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
            <button id="next-page" class="btn" title="Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©">Ø§Ù„ØªØ§Ù„ÙŠ</button>
            <button id="save-position" class="btn" title="Ø­ÙØ¸ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©">Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¶Ø¹</button>
          </div>
        </div>

        <!-- ÙˆØ¹Ø§Ø¡ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© -->
        <section id="page-container"
                 class="bg-[#111827] border border-gray-700 rounded-2xl p-4 md:p-8 space-y-4 quran-font custom-scrollbar">
          <p class="text-center text-gray-400">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©...</p>
        </section>
      </div>
    </main>
  </div>

  <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØµÙˆØª Ø§Ù„Ø³ÙÙ„ÙŠ -->
  <div class="fixed bottom-4 left-1/2 -translate-x-1/2 w-[94%] md:w-[70%] lg:w-[60%] audio-bar border border-gray-700 shadow-xl rounded-full px-4 py-2 flex items-center gap-3 z-50">
    <button id="play-toggle" class="btn" title="ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù">â–¶ï¸</button>

    <div class="relative">
      <select id="reciter" class="bg-[#0b1220] border border-gray-700 rounded-full px-3 py-2 text-sm text-gray-200">
        <!-- ÙŠÙÙ…Ù„Ø£ Ø¨Ø±Ù…Ø¬ÙŠÙ‹Ø§ -->
      </select>
    </div>

    <div class="flex-1 min-w-0">
      <div id="now-playing" class="truncate text-sm text-gray-300">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ´ØºÙŠÙ„ Ø­Ø§Ù„ÙŠÙ‹Ø§</div>
      <input id="seek" type="range" min="0" max="100" value="0" class="w-full accent-[#34d399]"/>
    </div>

    <div class="w-28 text-right text-xs text-gray-400">
      <span id="current-time">0:00</span> / <span id="duration">0:00</span>
    </div>

    <audio id="main-audio" class="hidden"></audio>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ³ÙŠØ± -->
  <div id="tafsir-modal" class="hidden fixed inset-0 bg-black/60 z-50 items-center justify-center">
    <div class="bg-[#111827] border border-gray-700 rounded-xl p-4 md:p-6 max-w-2xl w-[92%] text-gray-200">
      <div class="flex items-center justify-between mb-3">
        <h3 id="tafsir-title" class="font-bold">Ø§Ù„ØªÙØ³ÙŠØ±</h3>
        <button id="close-tafsir" class="btn">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div id="tafsir-body" class="whitespace-pre-line leading-8 text-gray-200 custom-scrollbar max-h-[60vh] overflow-y-auto"></div>
    </div>
  </div>

  <script>
    /* Ø¹Ù†Ø§ØµØ± DOM */
    const chaptersDrawer = document.getElementById('chapters-drawer');
    const toggleChapters = document.getElementById('toggle-chapters');
    const chaptersList   = document.getElementById('chapters-list');
    const chaptersSearch = document.getElementById('chapters-search');

    const pageContainer  = document.getElementById('page-container');
    const pageNumberEl   = document.getElementById('page-number');
    const surahTitleEl   = document.getElementById('surah-title');

    const prevPageBtn    = document.getElementById('prev-page');
    const nextPageBtn    = document.getElementById('next-page');
    const savePosBtn     = document.getElementById('save-position');

    const searchInput    = document.getElementById('search-input');
    const searchBtn      = document.getElementById('search-btn');

    const mainAudio      = document.getElementById('main-audio');
    const playToggleBtn  = document.getElementById('play-toggle');
    const nowPlaying     = document.getElementById('now-playing');
    const seek           = document.getElementById('seek');
    const currentTimeEl  = document.getElementById('current-time');
    const durationEl     = document.getElementById('duration');
    const reciterSelect  = document.getElementById('reciter');

    const tafsirModal    = document.getElementById('tafsir-modal');
    const tafsirTitle    = document.getElementById('tafsir-title');
    const tafsirBody     = document.getElementById('tafsir-body');
    const closeTafsirBtn = document.getElementById('close-tafsir');

    /* Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
    let chapters = [];
    let currentPage = 1;        // Ø±Ù‚Ù… ØµÙØ­Ø© Ø§Ù„Ù…ØµØ­Ù (1-604)
    let currentSurahName = 'Ø³ÙˆØ±Ø© Ø§Ù„ÙØ§ØªØ­Ø©';
    let versesOnPage = [];      // Ø¢ÙŠØ§Øª Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    let currentIndex = -1;      // Ù…Ø¤Ø´Ø± Ø§Ù„Ø¢ÙŠØ© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
    let playing = false;

    // Ù‚Ø§Ø¦Ù…Ø© Ù‚Ø±Ù‘Ø§Ø¡ Ù…Ø®ØµØµØ© (Ø¨Ø¯ÙˆÙ† Ø¨Ù†Ø¯Ø± Ø¨Ù„ÙŠÙ„Ø© ÙˆØ¨Ø¯ÙˆÙ† Ø§Ù„Ø³Ø¯ÙŠØ³)
    const RECITERS = [
      { id: 2,  name: 'Ø¹Ø¨Ø¯Ø§Ù„Ø¨Ø§Ø³Ø· Ø¹Ø¨Ø¯Ø§Ù„ØµÙ…Ø¯ (Ù…Ø¬ÙˆØ¯)' },
      { id: 7,  name: 'Ù…Ø´Ø§Ø±ÙŠ Ø±Ø§Ø´Ø¯ Ø§Ù„Ø¹ÙØ§Ø³ÙŠ' },
      { id: 3,  name: 'Ù…Ø­Ù…ÙˆØ¯ Ø®Ù„ÙŠÙ„ Ø§Ù„Ø­ØµØ±ÙŠ' },
      { id: 9,  name: 'Ù…Ø­Ù…Ø¯ ØµØ¯ÙŠÙ‚ Ø§Ù„Ù…Ù†Ø´Ø§ÙˆÙŠ' },
      { id: 8,  name: 'Ø³Ø¹ÙˆØ¯ Ø§Ù„Ø´Ø±ÙŠÙ…' },
      // Ù„Ø§ Ù†Ø¶ÙŠÙ Ø§Ù„Ø³Ø¯ÙŠØ³ ÙˆÙ„Ø§ Ø¨Ù†Ø¯Ø± Ø¨Ù„ÙŠÙ„Ø©
    ];

    // Ù…Ø¹Ø±Ù ØªÙØ³ÙŠØ± Ø¹Ø±Ø¨ÙŠ (Ù…Ø«Ø§Ù„: Ø§Ø¨Ù† ÙƒØ«ÙŠØ±)
    const DEFAULT_TAFSIR_ID = 171; // ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡ Ù„Ø§Ø­Ù‚Ù‹Ø§

    // Ø­ÙØ¸/Ø§Ø³ØªØ±Ø¬Ø§Ø¹
    function saveState(){
      localStorage.setItem('mushaf_maqra', JSON.stringify({
        page: currentPage,
        reciterId: reciterSelect.value,
        bookmark: getBookmark()
      }));
    }
    function loadState(){
      try{
        const raw = localStorage.getItem('mushaf_maqra');
        if(raw){
          const obj = JSON.parse(raw);
          if(obj.page) currentPage = obj.page;
          if(obj.reciterId) pendingReciterId = obj.reciterId;
          if(obj.bookmark) bookmarkKey = obj.bookmark;
        }
      }catch{}
    }
    let pendingReciterId = null;
    let bookmarkKey = null; // verse_key Ø§Ù„Ù…Ø¹Ù„Ù‘ÙÙ…
    function getBookmark(){ return bookmarkKey; }

    /* Ø£Ø¯ÙˆØ§Øª Ù…Ø³Ø§Ø¹Ø¯Ø© */
    const formatTime = (s) => {
      if (!isFinite(s) || s < 0) return '0:00';
      const m = Math.floor(s / 60);
      const sec = Math.floor(s % 60).toString().padStart(2, '0');
      return `${m}:${sec}`;
    };
    function stripEnglish(text){
      // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ Ø£Ø­Ø±Ù Ù„Ø§ØªÙŠÙ†ÙŠØ©/Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙˆØ±ÙˆØ§Ø¨Ø· Ù…Ù† Ø§Ù„ØªÙØ³ÙŠØ± Ø¥Ø°Ø§ Ø¸Ù‡Ø±Øª
      return (text || '').replace(/[A-Za-z]+/g, '').replace(/http[s]?:\/\/\S+/g,'').trim();
    }
    function highlightActiveAyah(){
      const blocks = pageContainer.querySelectorAll('.ayah-block');
      blocks.forEach((el, i) => {
        el.classList.toggle('ayah-active', i === currentIndex);
        // ØªØ·Ø¨ÙŠÙ‚ ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ©
        const vk = el.dataset.key;
        el.classList.toggle('bookmarked', vk && vk === bookmarkKey);
      });
      if (currentIndex >= 0){
        const target = blocks[currentIndex];
        target?.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
    function updateNavButtons(){
      prevPageBtn.disabled = (currentPage <= 1);
      nextPageBtn.disabled = (currentPage >= 604);
      pageNumberEl.textContent = currentPage;
    }

    /* ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù‚Ø±Ù‘Ø§Ø¡ */
    function populateReciters(){
      reciterSelect.innerHTML = '';
      for(const r of RECITERS){
        const opt = document.createElement('option');
        opt.value = r.id; opt.textContent = r.name;
        reciterSelect.appendChild(opt);
      }
      if(pendingReciterId && [...reciterSelect.options].some(o => o.value === String(pendingReciterId))){
        reciterSelect.value = String(pendingReciterId);
      }else{
        reciterSelect.value = '2'; // Ø¹Ø¨Ø¯Ø§Ù„Ø¨Ø§Ø³Ø· Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§
      }
    }

    /* ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙˆØ± */
    async function loadChapters(){
      try{
        const res = await fetch('https://api.quran.com/api/v4/chapters?language=ar');
        const data = await res.json();
        chapters = data.chapters || [];
        renderChapters(chapters);
        // Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ÙŠ ÙÙŠ Ø§Ù„Ø³ÙˆØ±
        chaptersSearch.addEventListener('input', () => {
          const q = chaptersSearch.value.trim();
          if(!q) return renderChapters(chapters);
          const filtered = chapters.filter(s =>
            String(s.id).includes(q) ||
            (s.name_arabic && s.name_arabic.includes(q)) ||
            (s.name_simple && s.name_simple.includes(q))
          );
          renderChapters(filtered);
        });
      }catch(e){
        chaptersList.innerHTML = `<div class="p-4 text-sm text-red-400">ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø§Ù„Ø³ÙˆØ±.</div>`;
      }
    }
    function renderChapters(list){
      chaptersList.innerHTML = '';
      list.forEach(surah => {
        const btn = document.createElement('button');
        btn.className = "w-full text-right p-4 hover:bg-[#0b1220] transition flex justify-between items-center";
        btn.innerHTML = `
          <span class="font-medium text-gray-200">${surah.id}. ${surah.name_arabic}</span>
          <span class="text-xs text-gray-400">${surah.verses_count} Ø¢ÙŠØ©</span>
        `;
        btn.onclick = () => openSurah(surah.id, surah.name_arabic, surah.pages);
        chaptersList.appendChild(btn);
      });
    }

    /* ÙØªØ­ Ø³ÙˆØ±Ø© (Ø§Ù„Ù‚ÙØ² Ù„Ø£ÙˆÙ„ ØµÙØ­Ø© Ù„Ù„Ø³ÙˆØ±Ø©) */
    function openSurah(id, name, pagesRange){
      currentSurahName = name;
      surahTitleEl.textContent = name;
      if (pagesRange && pagesRange.length === 2){
        currentPage = pagesRange[0];
      }
      loadPage(currentPage);
      // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¯ÙØ±Ø¬ Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„
      closeDrawer();
    }

    /* Ø¬Ù„Ø¨ Ø¢ÙŠØ§Øª ØµÙØ­Ø© Ù…ØµØ­Ù Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© */
    async function loadPage(pageNum){
      currentPage = Math.min(Math.max(1, Number(pageNum)||1), 604);
      updateNavButtons();
      pageContainer.innerHTML = `
        <div class="flex items-center gap-2 justify-center text-gray-300">
          <svg class="w-5 h-5 animate-spin" viewBox="0 0 24 24" fill="none">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="#34d399" stroke-width="4"></circle>
            <path class="opacity-75" fill="#059669" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
          <span>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©...</span>
        </div>
      `;
      try{
        // Ø¢ÙŠØ§Øª Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¹Ø«Ù…Ø§Ù†ÙŠ
        const url = `https://api.quran.com/api/v4/quran/verses/uthmani?page_number=${currentPage}`;
        const res = await fetch(url);
        const data = await res.json();
        versesOnPage = data.verses || [];
        renderPage(versesOnPage);
        // ØªØ­Ø¯ÙŠØ« Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø³ÙˆØ±Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø£ÙˆÙ„ Ø¢ÙŠØ© ÙÙŠ Ø§Ù„ØµÙØ­Ø©
        if(versesOnPage.length){
          const cid = versesOnPage[0].chapter_id;
          const surah = chapters.find(c => c.id === cid);
          if(surah){ currentSurahName = surah.name_arabic; surahTitleEl.textContent = surah.name_arabic; }
        }
        currentIndex = -1;
        highlightActiveAyah();
        nowPlaying.textContent = `ØµÙØ­Ø© ${currentPage} â€” ${currentSurahName}`;
        saveState();
      }catch(e){
        console.error(e);
        pageContainer.innerHTML = `<div class="text-center text-red-400">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©. Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ù‹Ø§.</div>`;
      }
    }

    /* Ø¹Ø±Ø¶ Ø§Ù„ØµÙØ­Ø© */
    function renderPage(list){
      pageContainer.innerHTML = '';
      list.forEach((v, idx) => {
        const wrap = document.createElement('article');
        wrap.className = "ayah-block border border-transparent rounded-2xl p-3 md:p-4 hover:border-[#2e3a48] transition";
        wrap.dataset.key = v.verse_key;
        wrap.dataset.idx = idx;

        const line = document.createElement('p');
        line.className = "quran-font text-2xl md:text-4xl leading-[2.4rem] md:leading-[4rem] text-gray-100 cursor-pointer";
        const ayahNum = v.verse_key.split(':')[1];
        line.innerHTML = `${v.text_uthmani} <span class="align-middle mx-2 text-sm md:text-base badge">(${ayahNum})</span>`;

        const actions = document.createElement('div');
        actions.className = "mt-2 flex items-center gap-2 text-sm text-gray-300";
        const playBtn = document.createElement('button');
        playBtn.className = "btn"; playBtn.textContent = 'ØªØ´ØºÙŠÙ„';
        playBtn.onclick = (ev) => { ev.stopPropagation(); playAyahByIndex(idx); };

        const tafsirBtn = document.createElement('button');
        tafsirBtn.className = "btn"; tafsirBtn.textContent = 'ØªÙØ³ÙŠØ±';
        tafsirBtn.onclick = (ev) => { ev.stopPropagation(); openTafsir(v.verse_key, currentSurahName, ayahNum); };

        actions.appendChild(playBtn);
        actions.appendChild(tafsirBtn);

        wrap.appendChild(line);
        wrap.appendChild(actions);
        wrap.onclick = () => { currentIndex = idx; highlightActiveAyah(); };
        pageContainer.appendChild(wrap);
      });

      // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³Ø­Ø¨ Ù„Ù„ØªÙ†Ù‚Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª (Ø¬ÙˆØ§Ù„)
      enableSwipe(pageContainer);
      // ØªØ·Ø¨ÙŠÙ‚ ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠØ© Ø¥Ù† ÙˆÙØ¬Ø¯Øª
      highlightActiveAyah();
    }

    /* ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„Ø¢ÙŠØ© */
    async function fetchAyahAudioUrl(verseKey){
      const recitationId = reciterSelect.value || 2;
      const url = `https://api.quran.com/api/v4/recitations/${recitationId}/by_ayah/${verseKey}`;
      const res = await fetch(url);
      if(!res.ok) throw new Error('ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØª');
      const data = await res.json();
      return `https://verses.quran.com/${data.audio_files[0].url}`;
    }
    async function playAyahByIndex(index){
      if(index<0 || index>=versesOnPage.length) return;
      currentIndex = index;
      const vk = versesOnPage[index].verse_key;
      const ayahNum = vk.split(':')[1];
      try{
        playToggleBtn.textContent = 'â¸ï¸';
        const audioUrl = await fetchAyahAudioUrl(vk);
        mainAudio.src = audioUrl;
        await mainAudio.play();
        playing = true;
        nowPlaying.textContent = `${currentSurahName} â€” Ø¢ÙŠØ© (${ayahNum})`;
        highlightActiveAyah();
      }catch(e){
        console.error(e);
        playing = false;
        playToggleBtn.textContent = 'â–¶ï¸';
        nowPlaying.textContent = 'ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª.';
      }
    }

    /* ØªÙØ³ÙŠØ± Ø§Ù„Ø¢ÙŠØ© (Ø¹Ø±Ø¨ÙŠ ÙÙ‚Ø· Ù…Ø¹ ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ) */
    async function openTafsir(verseKey, surahName, ayahNum){
      tafsirTitle.textContent = `ØªÙØ³ÙŠØ± ${surahName} (${ayahNum})`;
      tafsirBody.textContent = 'Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØªÙØ³ÙŠØ±...';
      tafsirModal.classList.remove('hidden');
      tafsirModal.classList.add('flex');

      try{
        const url = `https://api.quran.com/api/v4/tafsirs/${DEFAULT_TAFSIR_ID}/by_ayah/${verseKey}?language=ar`;
        const res = await fetch(url);
        if(res.ok){
          const data = await res.json();
          const t = data.tafsir?.text || data.tafsir?.plain_text || '';
          tafsirBody.textContent = stripEnglish(t);
        }else{
          tafsirBody.textContent = 'ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø§Ù„ØªÙØ³ÙŠØ±.';
        }
      }catch(e){
        console.error(e);
        tafsirBody.textContent = 'ØªØ¹Ø°Ø± Ø¬Ù„Ø¨ Ø§Ù„ØªÙØ³ÙŠØ±.';
      }
    }
    closeTafsirBtn.addEventListener('click', () => {
      tafsirModal.classList.add('hidden');
      tafsirModal.classList.remove('flex');
    });

    /* Ø­ÙØ¸ Ù…ÙˆØ¶Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© */
    function applyBookmarkStyle(){
      highlightActiveAyah();
    }
    savePosBtn.addEventListener('click', () => {
      const blocks = pageContainer.querySelectorAll('.ayah-block');
      let targetKey = null;
      if(currentIndex >= 0 && blocks[currentIndex]){
        targetKey = blocks[currentIndex].dataset.key;
      }else if(blocks.length){
        targetKey = blocks[0].dataset.key;
      }
      if(targetKey){
        bookmarkKey = targetKey;
        applyBookmarkStyle();
        saveState();
        nowPlaying.textContent = 'ØªÙ… Ø­ÙØ¸ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© âœ…';
      }
    });

    /* Ø²Ø± ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù */
    playToggleBtn.addEventListener('click', async () => {
      if (currentIndex < 0){
        // Ù„Ù… ØªÙØ­Ø¯Ø¯ Ø¢ÙŠØ©Ø› Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø§Ù„Ø£ÙˆÙ„Ù‰ ÙÙŠ Ø§Ù„ØµÙØ­Ø©
        await playAyahByIndex(0);
        return;
      }
      if (playing){
        mainAudio.pause(); playing = false; playToggleBtn.textContent = 'â–¶ï¸';
      }else{
        try{ await mainAudio.play(); playing = true; playToggleBtn.textContent = 'â¸ï¸'; }catch(e){}
      }
    });

    /* ØªÙ‚Ø¯Ù… Ø§Ù„ØªØ´ØºÙŠÙ„ */
    mainAudio.addEventListener('timeupdate', () => {
      if (!isFinite(mainAudio.duration) || mainAudio.duration <= 0) return;
      const ratio = (mainAudio.currentTime / mainAudio.duration) * 100;
      seek.value = Math.floor(ratio);
      currentTimeEl.textContent = formatTime(mainAudio.currentTime);
      durationEl.textContent = formatTime(mainAudio.duration);
    });
    mainAudio.addEventListener('ended', () => {
      if (currentIndex < versesOnPage.length - 1){
        playAyahByIndex(currentIndex + 1);
      }else{
        playing = false; playToggleBtn.textContent = 'â–¶ï¸';
      }
    });
    seek.addEventListener('input', () => {
      if (!isFinite(mainAudio.duration) || mainAudio.duration <= 0) return;
      const to = (seek.value / 100) * mainAudio.duration;
      mainAudio.currentTime = to;
    });

    /* ØªØºÙŠÙŠØ± Ø§Ù„Ù‚Ø§Ø±Ø¦ */
    reciterSelect.addEventListener('change', async () => {
      saveState();
      if(currentIndex >= 0){
        const wasTime = mainAudio.currentTime || 0;
        await playAyahByIndex(currentIndex);
        mainAudio.currentTime = wasTime;
      }
    });

    /* ØªÙ†Ù‚Ù„ Ø§Ù„ØµÙØ­Ø§Øª */
    prevPageBtn.addEventListener('click', () => { if(currentPage>1) loadPage(currentPage-1); });
    nextPageBtn.addEventListener('click', () => { if(currentPage<604) loadPage(currentPage+1); });

    /* Ø³Ø­Ø¨ Ù„Ù„ØªÙ†Ù‚Ù„ (RTL): Ø§Ù„Ø³Ø­Ø¨ Ù„Ù„ÙŠØ³Ø§Ø± => ØµÙØ­Ø© ØªØ§Ù„ÙŠØ©ØŒ Ù„Ù„ÙŠÙ…ÙŠÙ† => ØµÙØ­Ø© Ø³Ø§Ø¨Ù‚Ø© */
    function enableSwipe(el){
      let sx = 0, sy = 0, ex = 0, ey = 0;
      el.addEventListener('touchstart', (e) => {
        const t = e.changedTouches[0]; sx = t.clientX; sy = t.clientY;
      }, {passive:true});
      el.addEventListener('touchend', (e) => {
        const t = e.changedTouches[0]; ex = t.clientX; ey = t.clientY;
        const dx = ex - sx, dy = ey - sy;
        if(Math.abs(dx) > 50 && Math.abs(dy) < 60){
          if(dx < 0 && currentPage < 604) loadPage(currentPage+1);      // ÙŠØ³Ø§Ø± => Ø§Ù„ØªØ§Ù„ÙŠ
          else if(dx > 0 && currentPage > 1) loadPage(currentPage-1);   // ÙŠÙ…ÙŠÙ† => Ø§Ù„Ø³Ø§Ø¨Ù‚
        }
      }, {passive:true});
    }

    /* ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¯ÙØ±Ø¬ */
    let drawerOpen = false;
    function openDrawer(){ chaptersDrawer.style.transform = 'translateX(0)'; drawerOpen=true; }
    function closeDrawer(){ chaptersDrawer.style.transform = 'translateX(100%)'; drawerOpen=false; }
    toggleChapters.addEventListener('click', () => { drawerOpen ? closeDrawer() : openDrawer(); });

    /* Ø§Ù„Ø¨Ø­Ø«: Ø³ÙˆØ±Ø© Ø£Ùˆ Ø¢ÙŠØ© */
    async function handleSearch(){
      const q = (searchInput.value || '').trim();
      if(!q) return;

      // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ØµÙŠØºØ© Ø¢ÙŠØ© Ù…Ø«Ù„ 2:255
      if (/^\d{1,3}:\d{1,3}$/.test(q)){
        try{
          // Ø¬Ù„Ø¨ Ø§Ù„Ø¢ÙŠØ© Ù„Ù…Ø¹Ø±ÙØ© Ø±Ù‚Ù… Ø§Ù„ØµÙØ­Ø©
          const res = await fetch(`https://api.quran.com/api/v4/quran/verses/uthmani?verse_key=${q}`);
          const data = await res.json();
          const v = (data.verses || [])[0];
          if(v && v.page_number){
            currentPage = v.page_number;
            await loadPage(currentPage);
            // Ø­Ø¯Ù‘Ø¯ ØªÙ„Ùƒ Ø§Ù„Ø¢ÙŠØ© Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
            const idx = versesOnPage.findIndex(it => it.verse_key === q);
            if(idx >= 0){ currentIndex = idx; highlightActiveAyah(); }
          }
        }catch(e){ console.error(e); }
        return;
      }

      // Ø¥Ù† ÙƒØ§Ù† Ø±Ù‚Ù… Ø³ÙˆØ±Ø©
      if (/^\d{1,3}$/.test(q)){
        const s = chapters.find(c => String(c.id) === q);
        if(s) return openSurah(s.id, s.name_arabic, s.pages);
      }

      // Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠ
      const s2 = chapters.find(c => c.name_arabic && c.name_arabic.includes(q));
      if(s2) return openSurah(s2.id, s2.name_arabic, s2.pages);
    }
    searchBtn.addEventListener('click', handleSearch);
    searchInput.addEventListener('keydown', (e) => { if(e.key === 'Enter') handleSearch(); });

    /* Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ */
    document.addEventListener('keydown', (e) => {
      if(['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;
      if(e.code === 'Space'){ e.preventDefault(); playToggleBtn.click(); }
      else if(e.code === 'ArrowRight'){ prevPageBtn.click(); }
      else if(e.code === 'ArrowLeft'){ nextPageBtn.click(); }
    });

    /* Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ (IIFE Ù„ØªÙØ§Ø¯ÙŠ await Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø·Ø§Ù‚) */
    (async function init(){
      loadState();
      populateReciters();
      await loadChapters();
      await loadPage(currentPage);
    })();
  </script>
</body>
</html>

