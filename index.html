import { useState, useRef, useEffect, useCallback } from 'react';
import { Play, Pause, SkipBack, SkipForward, Volume2, VolumeX, Loader2, Save } from 'lucide-react';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Slider } from '@/components/ui/slider';

// قائمة القراء مع روابط مباشرة مستقرة
const RECITERS = [
  { id: '128/ar.alafasy', name: 'مشاري العفاسي' },
  { id: '128/ar.minshawi', name: 'محمد المنشاوي' },
  { id: '128/ar.abdulbasitmurattal', name: 'عبد الباسط عبد الصمد' },
  { id: '128/ar.abdulsamad', name: 'عبد الباسط (مجود)' },
  { id: '128/ar.mahermuaiqly', name: 'ماهر المعيقلي' },
  { id: '128/ar.hudhaify', name: 'الحذيفي' },
  { id: '128/ar.saoodshuraym', name: 'سعود الشريم' },
  { id: '128/ar.hanirifai', name: 'هاني الرفاعي' },
];

interface AudioPlayerProps {
  surahId: number;
  totalVerses: number;
  currentVerse: number;
  onVerseChange: (verse: number) => void;
}

const AudioPlayer = ({ surahId, totalVerses, currentVerse, onVerseChange }: AudioPlayerProps) => {
  const [isPlaying, setIsPlaying] = useState(false);
  const [isLoading, setIsLoading] = useState(false);
  const [reciter, setReciter] = useState(() => localStorage.getItem('quran-reciter') || '128/ar.alafasy');
  const [volume, setVolume] = useState(80);
  const [isMuted, setIsMuted] = useState(false);
  const [progress, setProgress] = useState(0);
  const [duration, setDuration] = useState(0);
  
  const audioRef = useRef<HTMLAudioElement | null>(null);

  // دالة حساب رقم الآية الكلي (Global Ayah ID) لضمان جلب الملف الصحيح
  const getGlobalAyahNumber = useCallback((sId: number, vId: number) => {
    // هذه العملية تعتمد على الـ API المستخدم (cdn.islamic.network)
    // نرسل رقم السورة والآية مباشرة في الرابط أدناه
    return `${sId}:${vId}`;
  }, []);

  // حفظ الإعدادات تلقائياً
  useEffect(() => {
    localStorage.setItem('quran-reciter', reciter);
    localStorage.setItem('quran-last-verse', currentVerse.toString());
    localStorage.setItem('quran-last-surah', surahId.toString());
  }, [reciter, currentVerse, surahId]);

  const stopAudio = () => {
    if (audioRef.current) {
      audioRef.current.pause();
      audioRef.current.currentTime = 0;
      audioRef.current.src = "";
    }
  };

  const loadAndPlay = useCallback(async (verseNum: number) => {
    if (!audioRef.current) return;
    
    stopAudio(); // منع تداخل الأصوات
    setIsLoading(true);

    // رابط API مباشر عالي الجودة (Every Ayah)
    const formattedAyah = `${surahId}${String(verseNum).padStart(3, '0')}`;
    const url = `https://verses.quran.com/?v=2&audio=${reciter.split('/')[1]}&verse=${surahId}:${verseNum}`;
    
    // بديل مستقر جداً
    const fallbackUrl = `https://cdn.islamic.network/quran/audio/${reciter}/${(await fetchGlobalId(surahId, verseNum))}.mp3`;

    audioRef.current.src = fallbackUrl;
    audioRef.current.load();

    try {
      await audioRef.current.play();
      setIsPlaying(true);
    } catch (err) {
      console.error("Playback error:", err);
    } finally {
      setIsLoading(false);
    }
  }, [surahId, reciter]);

  // دالة مساعدة لجلب المعرف العالمي للآية
  async function fetchGlobalId(s: number, v: number) {
     const response = await fetch(`https://api.alquran.cloud/v1/ayah/${s}:${v}`);
     const data = await response.json();
     return data.data.number;
  }

  useEffect(() => {
    if (isPlaying) loadAndPlay(currentVerse);
    return () => stopAudio();
  }, [currentVerse, reciter]);

  const handleTogglePlay = () => {
    if (isPlaying) {
      audioRef.current?.pause();
      setIsPlaying(false);
    } else {
      loadAndPlay(currentVerse);
    }
  };

  return (
    <div className="fixed bottom-0 left-0 right-0 bg-slate-900/95 backdrop-blur-2xl border-t border-amber-500/20 px-4 py-4 shadow-[0_-10px_40px_rgba(0,0,0,0.5)] z-50 transition-all duration-500">
      <audio 
        ref={audioRef}
        onTimeUpdate={() => setProgress(audioRef.current?.currentTime || 0)}
        onLoadedMetadata={() => setDuration(audioRef.current?.duration || 0)}
        onEnded={() => currentVerse < totalVerses ? onVerseChange(currentVerse + 1) : setIsPlaying(false)}
      />

      <div className="max-w-6xl mx-auto">
        {/* Progress Slider */}
        <div className="flex items-center gap-4 mb-4">
          <span className="text-[11px] text-amber-500/70 font-mono w-12 text-center">{Math.floor(progress / 60)}:{String(Math.floor(progress % 60)).padStart(2, '0')}</span>
          <Slider 
            value={[progress]} 
            max={duration || 100} 
            step={0.01}
            onValueChange={(val) => { if(audioRef.current) audioRef.current.currentTime = val[0] }}
            className="flex-1 accent-amber-500"
          />
          <span className="text-[11px] text-amber-500/70 font-mono w-12 text-center">{Math.floor(duration / 60)}:{String(Math.floor(duration % 60)).padStart(2, '0')}</span>
        </div>

        <div className="flex flex-wrap items-center justify-between gap-6">
          {/* Reciter Info */}
          <div className="flex items-center gap-4 w-full md:w-auto justify-center md:justify-start">
            <div className="hidden sm:block">
              <Select value={reciter} onValueChange={setReciter}>
                <SelectTrigger className="w-[200px] bg-slate-800 border-amber-500/30 text-amber-50 focus:ring-amber-500">
                  <SelectValue />
                </SelectTrigger>
                <SelectContent className="bg-slate-800 border-amber-500/30 text-amber-50">
                  {RECITERS.map(r => (
                    <SelectItem key={r.id} value={r.id} className="focus:bg-amber-500/20">{r.name}</SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
            <div className="text-right">
              <p className="text-amber-500 text-sm font-bold flex items-center gap-1 justify-end">
                <Save className="w-3 h-3" /> تم الحفظ تلقائياً
              </p>
              <p className="text-slate-400 text-xs">آية {currentVerse} من {totalVerses}</p>
            </div>
          </div>

          {/* Master Control Button (The Improved One) */}
          <div className="flex items-center gap-8 mx-auto">
            <button 
              onClick={() => onVerseChange(currentVerse - 1)}
              disabled={currentVerse <= 1}
              className="p-2 text-slate-400 hover:text-amber-500 disabled:opacity-20 transition-all"
            >
              <SkipBack className="w-7 h-7" />
            </button>

            <button
              onClick={handleTogglePlay}
              disabled={isLoading}
              className={`
                relative group flex items-center justify-center w-16 h-16 rounded-full 
                bg-gradient-to-br from-amber-400 to-amber-600 
                shadow-[0_0_20px_rgba(245,158,11,0.4)] 
                hover:shadow-[0_0_30px_rgba(245,158,11,0.6)] 
                active:scale-90 transition-all duration-300
                ${isLoading ? 'animate-pulse' : ''}
              `}
            >
              {isLoading ? (
                <Loader2 className="w-8 h-8 text-slate-900 animate-spin" />
              ) : isPlaying ? (
                <Pause className="w-8 h-8 text-slate-900 fill-current" />
              ) : (
                <Play className="w-8 h-8 text-slate-900 fill-current ml-1" />
              )}
              {/* Outer Ring Animation */}
              {isPlaying && !isLoading && (
                <span className="absolute inset-0 rounded-full border-2 border-amber-400 animate-ping opacity-20"></span>
              )}
            </button>

            <button 
              onClick={() => onVerseChange(currentVerse + 1)}
              disabled={currentVerse >= totalVerses}
              className="p-2 text-slate-400 hover:text-amber-500 disabled:opacity-20 transition-all"
            >
              <SkipForward className="w-7 h-7" />
            </button>
          </div>

          {/* Volume Control */}
          <div className="hidden lg:flex items-center gap-3 w-[200px] justify-end">
             <button onClick={() => setIsMuted(!isMuted)} className="text-amber-500/60 hover:text-amber-500 transition-colors">
                {isMuted ? <VolumeX size={20} /> : <Volume2 size={20} />}
             </button>
             <Slider 
                value={[isMuted ? 0 : volume]} 
                max={100} 
                onValueChange={(v) => { setVolume(v[0]); setIsMuted(false); }}
                className="w-24"
             />
          </div>
        </div>
      </div>
    </div>
  );
};

export default AudioPlayer;
